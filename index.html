<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Account Tracking & Availability Calendar</title>
  <!-- Datatables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  />
  <!-- Bootstrap 5 CSS (necesario para bootstrap-select) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- bootstrap-select CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css"
  />
  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    #logo {
      max-height: 180px;
      margin-right: 1rem;
    }
    header h1 {
      font-size: 1.75rem;
      color: #333;
      margin: 0;
    }
    #controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    #controls label {
      display: inline-flex;
      align-items: center;
      font-weight: 500;
    }
    #controls label span {
      margin-right: 0.5rem;
    }
    #controls select,
    #controls button {
      padding: 0.2rem 0.5rem;
      font-size: 0.9rem;
    }
    table.dataTable thead th {
      background: #007acc;
      color: #fff;
    }
    table.dataTable.display.stripe tbody tr.odd {
      background-color: #ffffff;
    }
    table.dataTable.display.stripe tbody tr.even {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <header>
    <img src="CJJ.png" alt="CJJ Visas & Asesorías logo" id="logo"/>
    <h1>Account Tracking & Availability Calendar</h1>
  </header>

  <div id="controls"></div>

  <table id="tbl" class="display stripe" style="width:100%">
    <thead>
      <tr>
        <th>Applicant</th>
        <th>Date</th>
        <th>Time</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Datatables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- bootstrap-select JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>

  <script>
  $(async () => {
    // 1) Carga y parseo del CSV
    const resp = await fetch('latest.csv');
    const text = await resp.text();
    const rows = text.trim().split('\n').slice(1);

    // 2) Poblar la tabla
    rows.forEach(line => {
      const [applicant, d, t, m] = line.split(',');
      $('#tbl tbody').append(\`
        <tr>
          <td>\${applicant}</td>
          <td>\${d}</td>
          <td>\${t}</td>
          <td>\${m}</td>
        </tr>
      \`);
    });

    // 3) Armar opciones de Availability
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const availSet = new Set();
    rows.forEach(line => {
      const msg = line.split(',')[3];
      const re = /\\b(\\d{4})-(\\d{2})-\\d{2}\\b/g;
      let match;
      while ((match = re.exec(msg)) !== null) {
        const year = match[1], mon = parseInt(match[2],10);
        if (year==="2025" || (year==="2026" && mon<=4)) {
          availSet.add(\`\${year}-\${monthNames[mon-1]}\`);
        }
      }
    });
    const availOpts = Array.from(availSet).sort().reverse();

    // 4) Extensión de búsqueda para multi-select
    $.fn.dataTable.ext.search.push((settings, data) => {
      const selApps  = $('#filter-applicant').val()  || [];
      const selAvail = $('#filter-availability').val() || [];

      if (selApps.length && !selApps.includes(data[0])) return false;

      if (selAvail.length) {
        const ok = selAvail.some(v => {
          const [year, abbr] = v.split('-');
          const monNum = ('0'+(monthNames.indexOf(abbr)+1)).slice(-2);
          return data[3].includes(\`\${year}-\${monNum}-\`);
        });
        if (!ok) return false;
      }
      return true;
    });

    // 5) Opciones de longitud de página
    const total = rows.length;
    const maxLen = Math.ceil(total/10)*10;
    const lengthOpts = [];
    for (let i=10; i<=maxLen; i+=10) lengthOpts.push(i);

    // 6) Inicializar DataTable
    const table = $('#tbl').DataTable({
      dom: 'lfrtip',
      responsive: true,
      order: [[1,'desc'],[2,'desc']],
      lengthMenu: [lengthOpts, lengthOpts],
      pageLength: lengthOpts[0],
      rowCallback: (row,data) => {
        const dt = data[3].match(/\\b(\\d{4})-(\\d{2})-\\d{2}\\b/);
        if (dt) {
          const year = dt[1], mon = parseInt(dt[2],10);
          if (year==="2025") $(row).css('background-color','#fff9c4');
          else if (year==="2026"&&mon<=4) $(row).css('background-color','#ffe0b2');
        }
      },
      language: {
        search: "Search:",
        lengthMenu: "Show _MENU_",
        info: "Showing _START_–_END_ of _TOTAL_",
        paginate: { first:"First", last:"Last", next:"Next", previous:"Prev" }
      }
    });

    // 7) Crear filtros con selectpicker
    const availFilter = $(\`
      <label id="filter-availability-label">
        <span>Availability:</span>
        <select id="filter-availability" multiple class="selectpicker" data-actions-box="true" title="All">
          <option value="">All</option>
          \${availOpts.map(v=>\`<option value="\${v}">\${v}</option>\`).join('')}
        </select>
      </label>\`);

    const applicantFilter = $(\`
      <label id="filter-applicant-label">
        <span>Applicant:</span>
        <select id="filter-applicant" multiple class="selectpicker" data-actions-box="true" title="All">
          <option value="">All</option>
        </select>
      </label>\`);
    table.column(0).data().unique().sort().each(val => {
      applicantFilter.find('select').append(\`<option value="\${val}">\${val}</option>\`);
    });

    // 8) Control de Refresh
    const refreshControl = $(\`
      <label id="refresh-label">
        <span>Refresh:</span>
        <select id="refresh-interval">
          <option value="0">Stop</option>
          <option value="5">5s</option>
          <option value="10">10s</option>
          <option value="20">20s</option>
          <option value="30">30s</option>
          <option value="60">60s</option>
        </select>
        <button id="refresh-now">Now</button>
      </label>\`);
    let timer;
    function setInt(v) {
      clearInterval(timer);
      localStorage.setItem('refresh-interval', v);
      const s = parseInt(v,10);
      if (s>0) timer = setInterval(()=>location.reload(), s*1000);
    }
    refreshControl.find('#refresh-interval').on('change', function(){ setInt(this.value); });
    refreshControl.find('#refresh-now').on('click', ()=>location.reload());
    const saved = localStorage.getItem('refresh-interval') || '0';
    refreshControl.find('#refresh-interval').val(saved);
    setInt(saved);

    // 9) Montar controles en orden original
    const ctr = $('#controls');
    availFilter.appendTo(ctr);
    $('#tbl_length').appendTo(ctr);
    applicantFilter.appendTo(ctr);
    $('#tbl_filter').appendTo(ctr);
    refreshControl.appendTo(ctr);

    // 10) Inicializar plugin y bind de eventos
    $('.selectpicker').selectpicker();
    $('#filter-availability').on('changed.bs.select', () => {
      // Cascada: Availability → Applicant
      const sel = $('#filter-availability').val()||[];
      const valid = new Set();
      rows.forEach(line=>{
        const [app,, ,msg] = line.split(',');
        if (!sel.length) valid.add(app);
        else if (sel.some(v=>{
          const [y,ab] = v.split('-');
          const num = ('0'+(monthNames.indexOf(ab)+1)).slice(-2);
          return msg.includes(\`\${y}-\${num}-\`);
        })) valid.add(app);
      });
      const $app = $('#filter-applicant');
      const prev = $app.val()||[];
      $app.empty().append('<option value="">All</option>');
      Array.from(valid).sort().forEach(a => $app.append(\`<option value="\${a}">\${a}</option>\`));
      $app.selectpicker('refresh').val(prev.filter(v=>valid.has(v)));
      table.draw();
    });
    $('#filter-applicant').on('changed.bs.select', () => table.draw());
  });
  </script>
</body>
</html>