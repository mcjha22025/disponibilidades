<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Account Tracking & Availability Calendar</title>
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    #logo {
      max-height: 180px;
      margin-right: 1rem;
    }

    /* Controls panel */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    #controls label {
      display: inline-flex;
      align-items: center;
      font-weight: 500;
    }
    #controls label span {
      margin-right: .5rem;
    }
    /* make multi-selects more legible */
    #filter-availability,
    #filter-applicant {
      min-width: 120px;
    }
  </style>
</head>
<body>
  <header>
    <img src="CJJ.png" alt="CJJ Visas & Asesorías logo" id="logo"/>
  </header>

  <div id="controls"></div>

  <table id="tbl" class="display stripe" style="width:100%">
    <thead>
      <tr>
        <th>Applicant</th>
        <th>Date</th>
        <th>Time</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    $(async () => {
      // 1) Load CSV and parse into objects
      const resp = await fetch('latest.csv');
      const text = await resp.text();
      const rawRows = text.trim().split('\n').slice(1);
      const dataRows = rawRows.map(line => {
        const [applicant, d, t, m] = line.split(',');
        return { applicant, d, t, m };
      });

      // 2) Populate table body
      dataRows.forEach(r => {
        $('#tbl tbody').append(`
          <tr>
            <td>${r.applicant}</td>
            <td>${r.d}</td>
            <td>${r.t}</td>
            <td>${r.m}</td>
          </tr>
        `);
      });

      // 3) Precompute month names
      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

      // 4) Build initial filter option sets
      function computeAvailabilitySet(rows) {
        const set = new Set();
        rows.forEach(r => {
          const re = /\b(\d{4})-(\d{2})-\d{2}\b/g;
          let m;
          while ((m = re.exec(r.m)) !== null) {
            const year = m[1], mon = parseInt(m[2],10);
            if (year==="2025"|| (year==="2026" && mon<=4)) {
              set.add(`${year}-${monthNames[mon-1]}`);
            }
          }
        });
        return Array.from(set).sort().reverse();
      }
      const availOptsAll = computeAvailabilitySet(dataRows);
      const applicantsAll = [...new Set(dataRows.map(r => r.applicant))].sort();

      // 5) Create multi‐select filters
      const availFilter = $(`
        <label>
          <span>Availability:</span>
          <select id="filter-availability" multiple size="${Math.min(availOptsAll.length,5)}">
            ${availOptsAll.map(v => `<option value="${v}">${v}</option>`).join('')}
          </select>
        </label>
      `);
      const applicantFilter = $(`
        <label>
          <span>Applicant:</span>
          <select id="filter-applicant" multiple size="${Math.min(applicantsAll.length,5)}">
            ${applicantsAll.map(a => `<option value="${a}">${a}</option>`).join('')}
          </select>
        </label>
      `);

      // 6) Append filters and DataTable length/search controls
      $('#controls')
        .append(availFilter)
        .append($('#tbl_length'))
        .append(applicantFilter)
        .append($('#tbl_filter'));

      // 7) Unified ext.search: applies both multi‐select filters
      $.fn.dataTable.ext.search.push((settings, data) => {
        const selA = $('#filter-applicant').val() || [];
        const selV = $('#filter-availability').val() || [];
        const appOk = selA.length === 0 || selA.includes(data[0]);
        let valOk = true;
        if (selV.length) {
          valOk = selV.some(v => {
            const [year, abbr] = v.split('-');
            const num = ('0' + (monthNames.indexOf(abbr) + 1)).slice(-2);
            return data[3].includes(`${year}-${num}-`);
          });
        }
        return appOk && valOk;
      });

      // 8) Initialize DataTable
      const table = $('#tbl').DataTable({
        dom: 'lfrtip',
        responsive: true,
        order: [[1,'desc'],[2,'desc']],
        rowCallback: (row,data) => {
          const m = data[3].match(/\b(\d{4})-(\d{2})-\d{2}\b/);
          if (m) {
            const year=m[1], mon=parseInt(m[2],10);
            if (year==="2025")       $(row).css('background-color','#fff9c4');
            else if (year==="2026"&&mon<=4) $(row).css('background-color','#ffe0b2');
          }
        },
        language: {
          search: "Search:", lengthMenu: "Show _MENU_",
          info: "Showing _START_–_END_ of _TOTAL_",
          paginate: { first:"First", last:"Last", next:"Next", previous:"Prev" }
        }
      });

      // 9) Cascading‐filter helpers
      function updateApplicantOptions() {
        const selV = $('#filter-availability').val() || [];
        const availFiltered = selV.length
          ? dataRows.filter(r => selV.some(v => {
              const [y,abbr] = v.split('-');
              const num = ('0' + (monthNames.indexOf(abbr)+1)).slice(-2);
              return r.m.includes(`${y}-${num}-`);
            }))
          : dataRows;
        const apps = [...new Set(availFiltered.map(r => r.applicant))].sort();
        const $sel = $('#filter-applicant');
        const prev = $sel.val()||[];
        $sel.empty();
        apps.forEach(a => $sel.append(`<option value="${a}">${a}</option>`));
        $sel.val(prev.filter(v=>apps.includes(v)));
      }

      function updateAvailabilityOptions() {
        const selA = $('#filter-applicant').val() || [];
        const appFiltered = selA.length
          ? dataRows.filter(r => selA.includes(r.applicant))
          : dataRows;
        const avs = computeAvailabilitySet(appFiltered);
        const $sel = $('#filter-availability');
        const prev = $sel.val()||[];
        $sel.empty();
        avs.forEach(v => $sel.append(`<option value="${v}">${v}</option>`));
        $sel.val(prev.filter(v=>avs.includes(v)));
      }

      // 10) Bind change events
      $('#filter-availability').on('change', () => {
        updateApplicantOptions();
        table.draw();
      });
      $('#filter-applicant').on('change', () => {
        updateAvailabilityOptions();
        table.draw();
      });
    });
  </script>
</body>
</html>